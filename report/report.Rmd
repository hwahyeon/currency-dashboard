---
title: "Currency Exchange Dashboard"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_depth: 2
    code_folding: hide
    theme: readable
---

```{r setup, include=FALSE}
library(tidyverse)
library(lubridate)
library(forecast)
library(prophet)
library(xgboost)
library(zoo)

history <- read_csv("../data/history.csv") %>% drop_na()
recent <- read_csv("../data/recent.csv")

exchange_data <- bind_rows(history, recent) %>%
  mutate(date = ymd(date)) %>%
  arrange(date)

common_currencies <- c("USD", "KRW")

run_forecasts <- function(data, currency_code) {
  df <- data %>% filter(currency == currency_code) %>%
    arrange(date) %>%
    mutate(date_num = as.numeric(date),
           weekday = wday(date),
           month = month(date))

  for (i in 1:5) {
    df[[paste0("lag_", i)]] <- lag(df$rate, i)
  }
  df <- df %>% drop_na()

  xgb_matrix <- xgb.DMatrix(
    data = as.matrix(df %>% select(starts_with("lag_"), date_num, weekday, month)),
    label = df$rate
  )
  model_xgb <- xgboost(data = xgb_matrix, nrounds = 100, objective = "reg:squarederror", verbose = 0)

  future_dates <- seq(max(df$date) + 1, by = "day", length.out = 7)
  lags <- tail(df$rate, 5)
  preds <- numeric(7)

  for (i in 1:7) {
    input <- tibble(
      lag_1 = lags[5], lag_2 = lags[4], lag_3 = lags[3],
      lag_4 = lags[2], lag_5 = lags[1],
      date_num = as.numeric(future_dates[i]),
      weekday = wday(future_dates[i]),
      month = month(future_dates[i])
    )
    preds[i] <- predict(model_xgb, xgb.DMatrix(as.matrix(input)))
    lags <- c(lags[-1], preds[i])
  }

  xgb_df <- tibble(date = future_dates, predicted = preds)

  ts_data <- ts(df$rate)
  arima_model <- auto.arima(ts_data)
  arima_fc <- forecast(arima_model, h = 7)
  arima_df <- tibble(date = future_dates, predicted = as.numeric(arima_fc$mean))

  prophet_df <- df %>% select(ds = date, y = rate)
  model_prophet <- prophet(prophet_df)
  future_df <- make_future_dataframe(model_prophet, periods = 7)
  prophet_fc <- predict(model_prophet, future_df)

  return(list(
    xgb = xgb_df,
    arima = arima_df,
    prophet = list(model = model_prophet, forecast = prophet_fc),
    raw = df
  ))
}

plot_visualization <- function(currency_code) {
  raw_data <- results[[currency_code]]$raw
  ggplot(raw_data, aes(x = date, y = rate)) +
    geom_line(color = 'steelblue') +
    labs(title = paste('Exchange Rate Over Time for', currency_code))
}

plot_xgboost_forecast <- function(currency_code, recent_months = 1) {
  raw_data <- results[[currency_code]]$raw
  pred_data <- results[[currency_code]]$xgb
  ggplot() +
    geom_line(data = raw_data %>% filter(date > max(date) - months(recent_months)),
              aes(x = date, y = rate), color = "gray") +
    geom_line(data = pred_data, aes(x = date, y = predicted), color = "green") +
    labs(title = paste("XGBoost Forecast for", currency_code))
}

plot_arima_forecast <- function(currency_code, recent_days = 7) {
  raw_data <- results[[currency_code]]$raw
  pred_data <- results[[currency_code]]$arima
  ggplot() +
    geom_line(data = raw_data %>% filter(date > max(date) - days(recent_days)),
              aes(x = date, y = rate), color = "gray") +
    geom_line(data = pred_data, aes(x = date, y = predicted), color = "purple") +
    labs(title = paste("ARIMA Forecast for", currency_code))
}

plot_recent_prophet <- function(forecast_df, history_df, days_before = 21) {
  last_train_date <- max(history_df$date)

  # match time zone
  tzone <- attr(forecast_df$ds, "tzone")
  last_train_date <- as.POSIXct(last_train_date, tz = tzone)

  start_plot <- last_train_date - days(days_before)

  forecast_df %>%
    filter(ds >= start_plot) %>%
    ggplot(aes(x = ds, y = yhat)) +
    geom_ribbon(aes(ymin = yhat_lower, ymax = yhat_upper), fill = "lightblue", alpha = 0.3) +
    geom_line(color = "blue") +
    labs(title = "Prophet Forecast (Recent)", x = "Date", y = "Rate")
}



results <- list()
for (cur in common_currencies) {
  results[[cur]] <- run_forecasts(exchange_data, cur)
}
```

# Forecast Dashboard {.tabset}

## USD {.tabset}

### Visualization
```{r}
plot_visualization("USD")
```

### XGBoost
```{r}
plot_xgboost_forecast("USD")
```

### ARIMA
```{r}
plot_arima_forecast("USD")
```

### Prophet
```{r}
plot_recent_prophet(results$USD$prophet$forecast, results$USD$raw)
```

## KRW {.tabset}

### Visualization
```{r}
plot_visualization("KRW")
```

### XGBoost
```{r}
plot_xgboost_forecast("KRW")
```

### ARIMA
```{r}
plot_arima_forecast("KRW")
```

### Prophet
```{r}
plot_recent_prophet(results$KRW$prophet$forecast, results$KRW$raw)
```